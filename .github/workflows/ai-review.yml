name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # OpenAI GPT-4 Code Review
  openai-review:
    name: OpenAI Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false && vars.OPENAI_API_KEY != ''

    steps:
      - name: Check OpenAI API Key
        id: check-openai
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è OpenAI API key not configured, skipping review"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úÖ OpenAI API key configured"
          fi

      - name: Checkout code
        if: steps.check-openai.outputs.skip == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: OpenAI PR Reviewer
        if: steps.check-openai.outputs.skip == 'false'
        uses: coderabbitai/ai-pr-reviewer@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          debug: false
          review_simple_changes: false
          review_comment_lgtm: false
          openai_light_model: gpt-4o-mini
          openai_heavy_model: gpt-4o
          openai_timeout_ms: 120000
          language: ja-JP
          path_filters: |
            !dist/**
            !build/**
            !node_modules/**
            !coverage/**
            !*.lock
            !*.log
          system_message: |
            „ÅÇ„Å™„Åü„ÅØBluesky OAuthÁµ±Âêà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº„ÇíË°å„ÅÜÂ∞ÇÈñÄ„ÅÆTypeScript/Node.jsÈñãÁô∫ËÄÖ„Åß„Åô„ÄÇ
            Êó•Êú¨Ë™û„Åß„É¨„Éì„É•„Éº„Ç≥„É°„É≥„Éà„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            ÈáçÁÇπÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÈ†ÖÁõÆÔºö
            1. „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÑÜÂº±ÊÄß„ÄÅÁâπ„Å´OAuth/DPoPÂÆüË£Ö„Å´„Å§„ÅÑ„Å¶
            2. TypeScriptÂûãÂÆâÂÖ®ÊÄß„Å®ÈÅ©Âàá„Å™„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
            3. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂïèÈ°å„Å®„É°„É¢„É™„É™„Éº„ÇØ
            4. „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ë¶èÁ¥Ñ„Å∏„ÅÆÊ∫ñÊã†ÔºàCLAUDE.mdÂèÇÁÖßÔºâ
            5. „Éá„Éº„Çø„Éô„Éº„Çπ„ÇØ„Ç®„É™„ÅÆÊúÄÈÅ©Âåñ„Å®Prisma„Éô„Çπ„Éà„Éó„É©„ÇØ„ÉÜ„Ç£„Çπ
            6. APIË®≠Ë®à„Å®„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ
            7. Ë™çË®º„Éï„É≠„Éº„ÅÆÊ≠£Á¢∫ÊÄß
            8. async/await„Å®Promise„ÅÆÈÅ©Âàá„Å™‰ΩøÁî®
            
            ÁÑ°Ë¶ñ„Åô„ÇãÈ†ÖÁõÆÔºö
            - ËªΩÂæÆ„Å™„Çπ„Çø„Ç§„É´ÂïèÈ°åÔºàPrettier„Åå„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÂá¶ÁêÜÔºâ
            - ÂçòÁ¥î„Å™„É™„Éç„Éº„É†„ÇÑ„É™„Éï„Ç°„ÇØ„Çø„É™„É≥„Ç∞
            - ÈáçÂ§ß„Å™Ë´ñÁêÜÁöÑÂïèÈ°å„Åå„Å™„ÅÑÈôê„Çä„ÅÆ„ÉÜ„Çπ„Éà„Éï„Ç°„Ç§„É´
            
            Âª∫Ë®≠ÁöÑ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÂÖ∑‰ΩìÁöÑ„Å™ÊèêÊ°à„Å®„Å®„ÇÇ„Å´Êó•Êú¨Ë™û„ÅßÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

      - name: Skip notification
        if: steps.check-openai.outputs.skip == 'true'
        run: echo "üîÑ OpenAI review skipped due to missing API key"

  # Anthropic Claude Code Review
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Check Claude API Key
        id: check-claude
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Anthropic API key not configured, skipping review"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Anthropic API key configured"
          fi

      - name: Checkout code
        if: steps.check-claude.outputs.skip == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        if: steps.check-claude.outputs.skip == 'false'
        uses: pnpm/action-setup@v4
        with:
          version: '10.13'

      - name: Setup Node.js
        if: steps.check-claude.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        if: steps.check-claude.outputs.skip == 'false'
        run: pnpm install --frozen-lockfile

      - name: Get changed files
        if: steps.check-claude.outputs.skip == 'false'
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            packages/**/*.ts
            packages/**/*.tsx
            *.ts
            *.js
          files_ignore: |
            **/*.test.ts
            **/*.spec.ts
            **/dist/**
            **/node_modules/**

      - name: Claude PR Review
        if: steps.check-claude.outputs.skip == 'false' && steps.changed-files.outputs.any_changed == 'true'
        uses: ./github/actions/claude-review
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          changed_files: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Skip notification
        if: steps.check-claude.outputs.skip == 'true'
        run: echo "üîÑ Claude review skipped due to missing API key"

  # Google Gemini Code Review
  gemini-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Check Gemini API Key
        id: check-gemini
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Gemini API key not configured, skipping review"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Gemini API key configured"
          fi

      - name: Checkout code
        if: steps.check-gemini.outputs.skip == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        if: steps.check-gemini.outputs.skip == 'false'
        uses: pnpm/action-setup@v4
        with:
          version: '10.13'

      - name: Setup Node.js
        if: steps.check-gemini.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        if: steps.check-gemini.outputs.skip == 'false'
        run: pnpm install --frozen-lockfile

      - name: Get changed files
        if: steps.check-gemini.outputs.skip == 'false'
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            packages/**/*.ts
            packages/**/*.tsx
            *.ts
            *.js
          files_ignore: |
            **/*.test.ts
            **/*.spec.ts
            **/dist/**
            **/node_modules/**

      - name: Gemini PR Review
        if: steps.check-gemini.outputs.skip == 'false' && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { GoogleGenerativeAI } = require('@google/generative-ai');
            const fs = require('fs');
            
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: 'gemini-1.5-pro' });
            
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ');
            
            for (const file of changedFiles) {
              if (!file || file.trim() === '') continue;
              
              try {
                const fileContent = fs.readFileSync(file, 'utf8');
                
                const prompt = `
                „ÅÇ„Å™„Åü„ÅØBluesky OAuthÁµ±Âêà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº„ÇíË°å„ÅÜÂ∞ÇÈñÄ„ÅÆTypeScript/Node.jsÈñãÁô∫ËÄÖ„Åß„Åô„ÄÇ
                ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÊó•Êú¨Ë™û„Åß„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                
                „Éï„Ç°„Ç§„É´Âêç: ${file}
                
                ÈáçÁÇπÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÈ†ÖÁõÆÔºö
                1. „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÑÜÂº±ÊÄß„ÄÅÁâπ„Å´OAuth/DPoPÂÆüË£Ö„Å´„Å§„ÅÑ„Å¶
                2. TypeScriptÂûãÂÆâÂÖ®ÊÄß„Å®ÈÅ©Âàá„Å™„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                3. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂïèÈ°å„Å®„É°„É¢„É™„É™„Éº„ÇØ
                4. „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ë¶èÁ¥Ñ„Å∏„ÅÆÊ∫ñÊã†
                5. „Éá„Éº„Çø„Éô„Éº„Çπ„ÇØ„Ç®„É™„ÅÆÊúÄÈÅ©Âåñ„Å®Prisma„Éô„Çπ„Éà„Éó„É©„ÇØ„ÉÜ„Ç£„Çπ
                6. APIË®≠Ë®à„Å®„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ
                7. Ë™çË®º„Éï„É≠„Éº„ÅÆÊ≠£Á¢∫ÊÄß
                8. async/await„Å®Promise„ÅÆÈÅ©Âàá„Å™‰ΩøÁî®
                
                ÁÑ°Ë¶ñ„Åô„ÇãÈ†ÖÁõÆÔºö
                - ËªΩÂæÆ„Å™„Çπ„Çø„Ç§„É´ÂïèÈ°åÔºàPrettier„Åå„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÂá¶ÁêÜÔºâ
                - ÂçòÁ¥î„Å™„É™„Éç„Éº„É†„ÇÑ„É™„Éï„Ç°„ÇØ„Çø„É™„É≥„Ç∞
                - ÈáçÂ§ß„Å™Ë´ñÁêÜÁöÑÂïèÈ°å„Åå„Å™„ÅÑÈôê„Çä„ÅÆ„ÉÜ„Çπ„Éà„Éï„Ç°„Ç§„É´
                
                Âª∫Ë®≠ÁöÑ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÂÖ∑‰ΩìÁöÑ„Å™ÊèêÊ°à„Å®„Å®„ÇÇ„Å´Êó•Êú¨Ë™û„ÅßÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                ÈáçÂ§ß„Å™ÂïèÈ°å„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Äå„Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÅØÈÅ©Âàá„Å´ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Äç„Å®ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                
                \`\`\`typescript
                ${fileContent}
                \`\`\`
                `;
                
                const result = await model.generateContent(prompt);
                const review = result.response.text();
                
                // GitHub PR „Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ÊäïÁ®ø
                if (review && !review.includes('ÈÅ©Âàá„Å´ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô')) {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.issue.number,
                    body: `## ü§ñ Gemini Code Review\n\n${review}`,
                    path: file,
                    line: 1,
                  });
                }
                
              } catch (error) {
                console.error(`Error reviewing file ${file}:`, error);
                
                // „Ç®„É©„Éº„Çí PR „Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ÊäïÁ®ø
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `## ‚ö†Ô∏è Gemini Review Error\n\n„Éï„Ç°„Ç§„É´ \`${file}\` „ÅÆ„É¨„Éì„É•„Éº‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`,
                });
              }
            }
            
            // ÂÖ®‰ΩìÁöÑ„Å™„É¨„Éì„É•„Éº„Çµ„Éû„É™„Éº„ÇíÊäïÁ®ø
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ü§ñ Gemini Review Complete\n\n${changedFiles.length} „Éï„Ç°„Ç§„É´„ÅÆ„É¨„Éì„É•„Éº„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ`,
            });

      - name: Install Gemini dependencies
        if: steps.check-gemini.outputs.skip == 'false' && steps.changed-files.outputs.any_changed == 'true'
        run: npm install @google/generative-ai

      - name: Skip notification
        if: steps.check-gemini.outputs.skip == 'true'
        run: echo "üîÑ Gemini review skipped due to missing API key"

  # Security-focused review
  security-review:
    name: Security Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.13'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint security rules
        run: pnpm run lint:security

      - name: Run Semgrep security analysis
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/typescript
            p/nodejs
          generateSarif: true

      - name: Upload Semgrep results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # OAuth/DPoP specific review
  oauth-review:
    name: OAuth Implementation Review
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'oauth') || contains(github.event.pull_request.changed_files, 'dpop')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check OAuth implementation
        run: |
          echo "üîç Reviewing OAuth/DPoP implementation..."
          
          # Check for common OAuth security issues
          if grep -r "client_secret" packages/frontend/ 2>/dev/null; then
            echo "‚ùå ERROR: Client secret found in frontend code!"
            exit 1
          fi
          
          # Check for proper DPoP implementation
          if ! grep -r "ES256" packages/backend/src/services/oauth/ 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: ES256 algorithm not found in OAuth service"
          fi
          
          # Check for token encryption
          if grep -r "accessToken.*:" packages/backend/ 2>/dev/null | grep -v "encrypt"; then
            echo "‚ö†Ô∏è WARNING: Potential unencrypted token storage"
          fi
          
          echo "‚úÖ OAuth implementation review completed"

      - name: Validate Client Metadata
        run: |
          if [ -f "packages/backend/public/.well-known/bluesky-oauth.json" ]; then
            echo "‚úÖ Client metadata file found"
            # Validate JSON structure
            node -e "
              try {
                const metadata = require('./packages/backend/public/.well-known/bluesky-oauth.json');
                const required = ['client_id', 'application_type', 'grant_types', 'response_types'];
                const missing = required.filter(key => !metadata[key]);
                if (missing.length > 0) {
                  console.log('‚ùå Missing required fields:', missing.join(', '));
                  process.exit(1);
                }
                console.log('‚úÖ Client metadata structure valid');
              } catch (error) {
                console.log('‚ö†Ô∏è WARNING: Could not validate client metadata:', error.message);
              }
            "
          else
            echo "‚ö†Ô∏è WARNING: Client metadata file not found"
          fi

  # Performance review
  performance-review:
    name: Performance Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.13'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Bundle size analysis
        run: |
          if [ -f "packages/shared/package.json" ] && [ -f "packages/backend/package.json" ] && [ -f "packages/frontend/package.json" ]; then
            pnpm run build || echo "‚ö†Ô∏è Build failed, skipping bundle analysis"
            
            # Check backend bundle size
            if [ -d "packages/backend/dist" ]; then
              backend_size=$(du -sh packages/backend/dist | cut -f1)
              echo "üì¶ Backend bundle size: $backend_size"
            fi
            
            # Check frontend bundle size
            if [ -d "packages/frontend/build" ]; then
              frontend_size=$(du -sh packages/frontend/build | cut -f1)
              echo "üì¶ Frontend bundle size: $frontend_size"
            fi
          else
            echo "‚ö†Ô∏è Package structure not ready, skipping bundle analysis"
          fi

      - name: Check for performance anti-patterns
        run: |
          echo "üîç Checking for performance issues..."
          
          # Check for inefficient database queries
          if grep -r "findMany.*include.*include" packages/backend/ 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: Potential N+1 query detected"
          fi
          
          # Check for memory leaks
          if grep -r "setInterval\|setTimeout" packages/backend/ 2>/dev/null | grep -v "clearInterval\|clearTimeout"; then
            echo "‚ö†Ô∏è WARNING: Potential memory leak - timers without cleanup"
          fi